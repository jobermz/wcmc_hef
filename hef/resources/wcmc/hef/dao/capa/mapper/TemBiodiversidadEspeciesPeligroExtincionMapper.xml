<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="wcmc.hef.dao.capa.mapper.TemBiodiversidadEspeciesPeligroExtincionMapper">
	<resultMap id="TemBiodiversidadEspeciesPeligroExtincionMap" type="wcmc.hef.dao.capa.domain.BeanRaster">
		<result column="avg" property="dblValuePromedio" jdbcType="DOUBLE"/>
		<result column="min" property="dblValueMin" jdbcType="DOUBLE"/>
		<result column="max" property="dblValueMax" jdbcType="DOUBLE"/>
		<result column="sum" property="lngValueCount" jdbcType="BIGINT"/>
		<result column="stddev" property="dblStddev" jdbcType="DOUBLE"/>
	</resultMap>
	
	<select id="selectByGeometry" resultMap="TemBiodiversidadEspeciesPeligroExtincionMap" parameterType="wcmc.hef.dao.capa.domain.BeanRaster" >
		select sum(e.count), avg(e.mean), min(e.min), max(e.max), stddev(e.stddev) from
		(select (ST_SummaryStats(c.Clip, true)).*
		from (SELECT ST_Clip(A.cd_rast, QRY.geom, true) AS Clip
			FROM wcmc_hef.tem_biodiversidad_especies_peligro_extincion AS A,
				(select geom from ST_Transform(ST_GeomFromText(#{strPoligonoConsulta,jdbcType=VARCHAR}, 4326),32718) as geom) as QRY
			WHERE ST_Intersects(A.cd_rast, 1, QRY.geom)) as c) as e
	</select>
	
	<select id="selectGeometryByRangoAndGeometry" resultType="String" parameterType="wcmc.hef.dao.capa.domain.BeanRaster" >
		SELECT ST_AsText(ST_Polygon(ST_Reclass(t.Clip,1,'[${strRangoConsulta}]:[${strRangoConsulta}]'::text, '8BUI'::text,0))) 
		FROM (SELECT ST_Clip(A.cd_rast, QRY.geom, true) AS Clip
				FROM wcmc_hef.tem_biodiversidad_especies_peligro_extincion AS A,
					(select geom from ST_Transform(ST_GeomFromText(#{strPoligonoConsulta,jdbcType=VARCHAR}, 4326),32718) as geom) as QRY
				WHERE ST_Intersects(A.cd_rast, 1, QRY.geom)) as t
	</select>
	
</mapper>
